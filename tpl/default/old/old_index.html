{include file="old/old_header.html"}
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/index.css"/>
<div id="nav">
    <div class="top">
        <div class="top_left">
            <a href="{$pre}"></a>
        </div>
        <div class="top_center"><img src="{$TMPL}/old/images/huan.png" width="55%" style="max-width: 100px;"></div>
        <div class="top_right"></div>
    </div>
</div>
<div class="box">
    <!--<div><button type="button" style="width: 80px" onclick="up()">up</button><button type="button" style="width: 80px" onclick="down()">down</button></div>-->
    <div id="content">
        <!--<div class="grid-sizer"></div>&lt;!&ndash;控制初始宽度&ndash;&gt;-->
        {if $error}<div class="empty">{$error}</div>{/if}
        {foreach from=$goods item=good_list key=keyd}
        {if $good_list.online_state eq 1}
        <div class="content_list" data-index="{$good_list.id}">
            <a href="{url_wap r="old#detail" p="id=$good_list.id"}" class="content_list_link">
                <img original="{if $good_list.head_image}{$good_list.head_image}{else}{$TMPL}/old/images/holder.png{/if}" src="{$TMPL}/old/images/holder.png" class="lazy img-responsive {if $good_list.is_filter eq 1}backdrop{/if}">
            </a>
            <div class="content_list_bottom">
                <img src="{$good_list.avatar}" class="img-circle circle">
                <a href="{url_wap r="old#detail" p="id=$good_list.id"}" class="font_title">{$good_list.name}</a>
            </div>
            <div class="content_list_bottoma">
                {if $good_list.is_focus}
                <img src="{$TMPL}/old/images/zan_hover.png" data-src="{$TMPL}/old/images/zan.png" border="0" onclick="old.add_focus(this,'{$user.id}','{$good_list.id}')">
                {else}
                <img src="{$TMPL}/old/images/zan.png" data-src="{$TMPL}/old/images/zan_hover.png" border="0" onclick="old.add_focus(this,'{$user.id}','{$good_list.id}')">
                {/if}
                <span>{$good_list.focus_num}</span>
            </div>
        </div>
        {/if}
        {/foreach}
    </div>

</div>
</div>

{include file="old/old_footer.html"}
<!--<script type="text/javascript" src="{$TMPL}/old/js/masonry.pkgd.min.js"></script>-->
<script type="text/javascript" src="{$TMPL}/old/js/imagesloaded.pkgd.js"></script>
<script type="text/javascript" src="{$TMPL}/js/dropload.js"></script>
<!--<script type="text/javascript" src="{$TMPL}/old/js/old_index.js"></script>-->
<script>
    var w = window;
    var new_close = 0;
    var ajax_flag=null;
    var page = {$page};
    var url = APP_ROOT + '?ctl=old';
    var boxArr = $('.content_list');
    var $loading = $('#loading');
    var $grid = $('#content');
    var columnHeightArr = [];
    var all_old_num = 0;
    var onload_img_num = 0;
    var autoset = null;
    var storage = window.localStorage;
    var a = storage.ab;
//    alert(a)
//    console.log(a);
    /*$(function(){
        $(window).on('beforeunload',unloadHandler);
        $(window).on('unload',unloadHandler);
        console.log(a);
    })*/
    /*if(window.localStorage){
        alert('This browser supports localStorage');
    }else{
        alert('This browser does NOT support localStorage');
    }*/

//    tools.addHandler(w, "beforeunload", unloadHandler);
    tools.addHandler(w, "pagehide", unloadHandler);//只有pagehide是iphone safari&wechat中好使的，android也有效

    /*tools.addHandler(w, "pageshow", function (event) {
        console.log(event.persisted);
        if (event.persisted) {
            console.log("From back / forward cache.");
        }
    });*/
    function unloadHandler(event){
        var now_items = $('.now'),arr=[];
        now_items.each(function(index,item){
            arr.push(item.dataset.index);
        })
        if(arr.length>0){
            if(window.localStorage){
                storage.ab = arr.toString();
            }else{
                //不支持storage的保存cookie
            }


        }
//        console.log(arr);
//        event.returnValue = storage.ab;
    }
    w.onload = w.onresize = function(){
        initFall();
        $grid.dropload({
            scrollArea : window,
            loadUpFn:function(me){
                window.location.reload();
                me.resetload();
            }/*,
            loadDownFn : function(me){
                onScroll();
                me.resetload();
            }*/
        });
    }
    w.onscroll = function(){
    	var h = $(document).height();  //页面高度
        var c = $(document).scrollTop(); //滚动条top
        var wh = $(window).height(); //页面可是区域高度
        var s = h - (c + wh);
        if (s==0) {
            if(new_close==0){
                onScroll();
            }
        }
        var boxArrs = $grid.find('.content_list');
        boxArrs.each(function(index, item){
            var a = $(item);
            //计算可视区域的item
            if(c<(a.offset().top+a.outerHeight()- (a.height()/2))&&(c>(a.offset().top-wh+(a.height()/2)))){
                a.addClass('now');
            }else{
                a.removeClass('now');
            }
        });

    }
    function initFall(){
        var boxArr = $('.content_list'),
                num = Math.floor(document.body.clientWidth / boxArr.eq(0).outerWidth(true));
        all_old_num = 0;
        onload_img_num = 0;
        boxArr.each(function(index, item) {
	        	var onload_img = $(item).find('.lazy');
	        	if(onload_img.height()!=0){
	        		onload_img_num++;
	        	}
	        	all_old_num++;
						if (index < num) {
                columnHeightArr[index] = $(item).outerHeight(true)+50;//增加box的margin－top高度
//                console.log(columnHeightArr);
            } else {
//                console.log(item.id)
                var minHeight = Math.min.apply(null, columnHeightArr),
                        minHeightIndex = $.inArray(minHeight, columnHeightArr);
//                console.log(minHeight);
								      	$(item).css({
			                    position: 'absolute',
			                    top: minHeight,
			                    left: boxArr.eq(minHeightIndex).position().left});
                columnHeightArr[minHeightIndex] += $(item).outerHeight(true);
            }
        });
        if(all_old_num == onload_img_num){
//        	console.log('ok');
        	if(typeof(autoset) != "undefined"){
        		clearInterval(autoset);
        	}
        }
    }
    
    
    function onScroll() {
    		new_close = 1;
        var $window = $(window);
        var $document = $(document)
        var winHeight = window.innerHeight ? window.innerHeight : $window.height();

        var closeToBottom = ($window.scrollTop() + winHeight > $document.height() - 100);

        if (closeToBottom) {
        		if(typeof(autoset) != "undefined"){
        			clearInterval(autoset);
        		}
            var nowpage = page;
            nowpage++;
            var p = {p: nowpage, ajax: 1, pagesize: 10};
            $loading.show();
            ajax_flag = $.ajax({
                url: url, dataType: "json", type: "get", data: p,
                success: function (json) {
                    $loading.hide();
                    if(json.now_page==page)return;
                    if (json.goods.error == 0) {
                        page = json.now_page;
                        var goods=json.goods.data;
                        for(var i=0;i<goods.length;i++){
                            var htmlStr = '<div class="content_list content_add_item" data-index="'+goods[i].id+'"><a href="'+APP_ROOT+'?ctl=old&act=detail&id='+goods[i].id+'"  class="content_list_link"><img original="'+goods[i].head_image+'" src="{$TMPL}/old/images/holder.png" class="lazy img-responsive backdrop"></a><div class="content_list_bottom">';
                            htmlStr += '<img src="'+goods[i].avatar+'" class="img-circle circle">';
                            htmlStr +=  '<a href="{url_wap r="old#detail" p="id='+goods[i].id+'"}" class="font_title">'+goods[i].name+'</a></div><div class="content_list_bottoma">';
                            if(goods[i].is_focus){
                                htmlStr += '<img src="{$TMPL}/old/images/zan_hover.png" data-src="{$TMPL}/old/images/zan.png" border="0" onclick="old.add_focus(this,"{$user.id}",'+goods[i].id+')">';
                            }else{
                                htmlStr += '<img src="{$TMPL}/old/images/zan.png" data-src="{$TMPL}/old/images/zan_hover.png" border="0" onclick="old.add_focus(this,"{$user.id}",'+goods[i].id+')">';
                            }
                            htmlStr += '<span>'+goods[i].focus_num+'</span></div></div>';

                            $grid.append($(htmlStr));
                            $(htmlStr).imagesLoaded( function() {
                                $grid.find('.content_add_item').animate({opacity:1},100);
                            });
                        }
                        ajax_flag=null;
                        $grid.find('.lazy').lazyload();
                        initFall();
                        new_close=0;
                        autoset = setInterval("initFall()",100);
                    }
                }, error:function(e){
                    console.log(e.responseText);
                }
            });
        }

    };
</script>
</body>
</html>