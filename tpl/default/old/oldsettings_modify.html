{include file="old/old_header.html"}
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/old_settings.css"/>
<div class="conper">
  <img width="100%" height=200 src="{$TMPL}/old/images/home_bg.png" style="position:absolute;top:0;display:block;"/>
   <a onClick="javascript:upd_file(this,'avatar_file');">
   <div class="conper_pic">
       <img id="avatar" src="{function name="get_user_avatar" uid=$user_info.id type="middle"}" width="100%" onClick="javascript:upd_file(this,'avatar_file');">
       <h4>修改头像</h4>
       <input type="file" class="filebox" name="avatar_file" id="avatar_file"  style=" position:absolute;top:0;left:0;cursor:pointer;padding: 0;height:100%;width:100%;filter: alpha(opacity=0);-moz-opacity: 0;-khtml-opacity: 0;opacity: 0;"/>
   </div></a>
</div>
	 <div class="con_self" style="margin-top:3%;">
	    <div class="con_self_right">
            <span class="con_self_right_font">我的账号</span>

            <input class="con_self_right_img" value="{$user_info.user_name}" style="text-align: right;border: none;" name="user_name">
		</div>
	 </div>
     <div class="con_self">
	    <div class="con_self_right">
            <span class="con_self_right_font">我的姓名</span>
		   <a href="#" class="con_self_right_img">{if $user_info.identify_name}{$user_info.identify_name}{else}&nbsp{/if}</a>
		</div>
	 </div>
 	 <div class="con_self" style="margin-bottom:3%;">
	    <div class="con_self_right" style="border-bottom:none;">
            <span class="con_self_right_font">手机号码</span>
		   <a href="#" class="con_self_right_img" id="mobile">{$user_info.mobile}</a>
		</div>
	 </div> 
	 <div class="con_self">
	    <div class="con_self_right">
            <span class="con_self_right_font">我的性别</span>
		   <a href="#" class="con_self_right_img" id="sex" data-sex="{$user_info.sex}" data-target="#sexModal" data-toggle="modal">
               <em>
               {if $user_info.sex eq 1}男{/if}
               {if $user_info.sex eq 0}女{/if}
               {if $user_info.sex eq -1}未知{/if}
               </em></a>
		</div>
	 </div>	
	 	 <!--性别end-->

 	 <div class="con_self" style="margin-bottom:3%;">
	    <div class="con_self_right" style="border-bottom:none;">
            <span class="con_self_right_font">所在地区</span>
		   <a href="#" class="con_self_right_img" id="area" data-province="{$user_info.province}" data-city="{$user_info.city}" data-target="#areaModal" data-toggle="modal"><em>{if $user_info.province neq ''}{$user_info.province} {$user_info.city} {else}未填写{/if}</em></a>
		     <!--所在地区end-->

		</div>
	 </div>
     <!--address editor-->
     <div class="con_self" style="margin-bottom:3%;">
         <div class="con_self_right" style="border-bottom:none;">
             <span class="con_self_right_font">地址管理</span>
             <a href="{url_wap r="old#consignee"}" class="con_self_right_img" id="address"><em></em></a>
             <!--地址管理end-->
         </div>
     </div>
    <div class="con_self">
	    <div class="con_self_right">
            <span class="con_self_right_font">我的邮箱</span>
		   <a href="#" class="con_self_right_img" id="email" data-email="{$user_info.email}"  data-target="#emailModal" data-toggle="modal"><em>{if $user_info.email eq ''}未填写{/if}{function name="msubstr" v=$user_info.email b=0 e=10}</em></a>
		</div>
	 </div>
		     <!--邮箱end-->

 	 <div class="con_self" style="margin-bottom:80px;">
	    <div class="con_self_right" style="border-bottom:none;">
		   <span class="con_self_right_font">个人简介</span>
		   <a href="#" class="con_self_right_img" id="intro" data-target="#introModal" data-toggle="modal"><em>{if $user_info.intro eq ''}未填写{/if}
               {function name="msubstr" v=$user_info.intro b=0 e=10}
           </em></a>
            <input hidden="hidden" id="introText" value="{$user_info.intro}"/><!--保存用户填写的个人简介-->
		</div>
	 </div>
        <!--简介end-->
	<div class="one_btn_footer">
      <button class="butn1" type="button" onClick="javascript:save_modify();">保存</button>
    </div>
   <!--底部-->
{include file="old/old_footer.html"}
{include file="old/modals.html"}
 <script type="text/javascript" src="{$TMPL}/old/js/switch_city.js"></script>
 <script type="text/javascript" src="../system/region.js"></script>
 <script type="text/javascript" src="{$TMPL}/js/avatar.js"></script>
 <script type="text/javascript" src="{$TMPL}/js/ajaxupload.js"></script>
 <script>
     $(function(){
         $("#emailSubmit").click(editEmail);
         $("#introSubmit").click(editIntro);
         $("#sex").click(editSex);
         $("#areaSubmit").click(editArea);
         $(".closebox").on("click",bindClose);
     });
     function editEmail(){
         var v = $("#emailValue").val();
         if($.checkEmail($.trim(v))){
             $("#email>em").html(v);
             $("#email").attr("data-email",v);
         }else{
             $.showErr("请填写正确的Email");
         }
     }
     function editIntro(){
         $("#intro>em").html("已填写");
         $("#introText").val($.trim($("#introValue").val()));
     }
     function editSex(){
         $("#sexlist>li").on("click",function(){
             var $this =  $(this),$dataSex = $("#sex"),$checked = $.trim($this.find("input[name='sex']").val()),str = "";
             //选择性别后填入#sex的data-sex中，把选择结果填入#sex>em中显示在页面上
             $dataSex.attr("data-sex",$checked);
             switch ($checked){
                 case "1":str = "男";break;
                 case "0":str = "女";break;
                 default :str = "未知";break;
             }
             $dataSex.find("em").html(str);
             //交替选中样式
             if(!$this.hasClass("onchecked")){
                 $this.addClass("onchecked").siblings().removeClass("onchecked");
             }

         });
     }
     function editArea(){
         $("#area>em").html($("#provinceValue").html()+"&nbsp;&nbsp;"+$("#cityValue").html());
     }
     function bindClose(){
         $.weeboxs.close();
     }
     //提交信息
     function save_modify(){
         var param = {
             province:$("#area").attr("data-province"),
             city:$("#area").attr("data-city"),
             intro:$("#introText").val(),
             mobile:$("#mobile").html(),
             sex:$("#sex").attr("data-sex"),
             email:$("#email").attr("data-email"),
             user_name:$('input[name="user_name"]').val()
         };
         var post_url='{url_wap r="oldsettings#save_modify"}';

//         alert(param.province+"---"+param.city+"---"+param.mobile+"---"+param.sex+"---"+param.intro+"---"+param.email)
         $.ajax({
             url:post_url,
             dataType:"json",
             data:param,
             type:"post",
             cache:false,
             success:function(data){
//                 console.log(data.info)
                     $.showSuccess(data.info,function() {
                         window.location.href = APP_ROOT+'?ctl=oldsettings';
//                         window.location.reload();
                     });
                 },
             error:function(){
                 $.showErr("服务器繁忙，请您稍后再试！");
             }
         });
         return false;
     }
     //上传头像
     function upd_file(obj,file_id){
         var $loading = $("#loading");
         $("input[name='"+file_id+"']").on("change",function(){
//             $(obj).hide();
             $loading.show();
             $.ajaxFileUpload(
                     {
                         url:'{url_wap r="avatar#upload"}&uid={$user_info.id}',
                         secureuri:false,
                         fileElementId:file_id,
                         dataType: 'json',
                         success: function (data, status) {
//                             $(obj).show();
                             $loading.hide();
                             if(data.status==1)
                             {
                                 document.getElementById("avatar").src = data.middle_url+"?r="+Math.random();
                             }else{
                                 $.showErr(data.msg);
                             }
                         },error: function (data, status, e) {
                             $loading.hide();
                             $.showErr(data.responseText);
                                 $(obj).show();
                             }
                     }
             );
             $("input[name='"+file_id+"']").unbind("change");
         });
     }
 </script>
 </body>
</html>