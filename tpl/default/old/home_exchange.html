{include file="old/old_header.html"}
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/change_invation.css"/>
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/cans.css"/>
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/pay.css"/>
<script>
    var expressList={};
</script>
<div id="nav">
    <div class="top">
        <div class="top_left">
            <a href="javascript:window.history.go(-1)"><img src="{$TMPL}/old/images/exit.png"></a>
        </div>
        <div class="top_center">{$page_title}</div>
        <div class="top_right"></div>
    </div>
</div>
<div class="change_invation">
    <div class="change_invation_top">
        <!------------------tab_nav-------------------->
        <ul id="myTab" class="nav nav-tabs">
            <li><a href="#home" data-toggle="tab">申请我的</a></li>
            <li><a href="#my_exchange" data-toggle="tab">我申请的</a></li>
        </ul>
<!-- From = me ; To = other-->
    <div id="myTabContent" class="tab-content">
        <div class="tab-pane fade" id="home">
            <!--Empty-->
            {if $from_error}
            <section class="change_Panels"><div class="exchange_empty"><span>{$from_error}</span><a href="{url_wap r="old"}">看看有哪些好玩的东东先</a></div></section>
            {/if}
            <!--Not Empty-->
            {foreach from=$from_user_goods item=good_list key=keyd}
            {assign var=state value=$good_list.state_num}
                <article class="change_Panels">
                    <header class="change_title clearfix">
                                <span class="change_title_left">
                                    <img src="{function name="get_user_avatar" uid=$good_list.to_user_data.id type="middle"}" " border=0 width=15 class="img-circle">
                                    {$good_list.to_user_data.user_name}-HUAN单号:{$good_list.id}-状态：{$state}
                                </span>
                        <span class="change_title_right">{$good_list.create_time}</span>
                    </header>
                    <div class="change_body clearfix">
                        <div class="change_body1">
                            {foreach from=$good_list.to_images_data.list item=img_list key=keyd}
                            {if $img_list.is_top eq 1}
                            <!--获取封面-->
                            <a href="{url_wap r="old#detail" p="id=$img_list.goods_id"}"><img src="{$TMPL}/old/images/holder.png" original="{$img_list.url}" border=0 width=100% class="lazy"></a>
                            {/if}
                            {/foreach}
                        </div>
                        <div class="change_body2">
                            <img src="{$TMPL}/old/images/change.png" border=0 width=100%>
                        </div>
                        <div class="change_body3">
                            {foreach from=$good_list.from_images_data.list item=img_list key=keyd}
                            {if $img_list.is_top eq 1}
                            <!--获取封面-->
                            <a href="{url_wap r="old#detail" p="id=$img_list.goods_id"}"><img src="{$TMPL}/old/images/holder.png" original="{$img_list.url}" border=0 width=100% class="lazy"></a>
                            {/if}
                            {/foreach}
                        </div>
                    </div>
                    <!--各种状态开始-->
                    {if $state eq 1}
                    <footer class="change_foot clearfix">
                        <span>{$good_list.to_user_data.user_name}想和您交换物品，是否同意？</span>
                        <div  class="change_foot_body">
                            <a href="javascript:old.set_exchange({$good_list.id})" class="change_agree">同意</a>
                            <a href="javascript:old.ignore_exchange(this,{$good_list.id})" class="change_disagree">忽略</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 3}
                    <footer class="change_foot clearfix">
                        <span>{$good_list.to_user_data.user_name}放弃此次交换，系统已经自动为您重新上架。</span>
                        <div class="change_foot_body">
                            <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.del_exchange(this,'{$good_list.id}','from')">确认</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 5}
                    <footer class="change_foot clearfix">
                        <span>你已经同意交换，请等待对方选择交换方式。</span>
                        <div class="change_foot_body">
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_agree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 7} <!--对方选择线下交换-->
                        <footer class="change_foot clearfix">
                            <span>{$good_list.to_user_data.user_name}想用私下交换的方式和您交换物品，是否同意？</span>
                            <div class="change_foot_body">
                                <a href="javascript:void(0)" class="change_agree" onclick="old.agree_exchange_type('{$good_list.id}','from',{$user.id},'{$good_list.exchange_log.from_deposit}')">同意</a>
                                <a href="#" class="change_disagree" data-toggle="modal" data-target="#exMethodModal" data-exchange-id="{$good_list.id}" data-user-type="from" data-other-deposit="{$good_list.exchange_log.to_deposit}">更换交换方式</a>
                            </div>
                        </footer>
                    {/if}<!--State 7 END-->
                    {if $state eq 9}<!--对方选择线上交换-->
                    <footer class="change_foot clearfix">
                        <span>{$good_list.to_user_data.user_name}想用担保交换的方式和您交换物品，担保金额为¥{$good_list.exchange_log.to_deposit}，是否同意？</span><!--State 16-->
                        <div class="change_foot_body">
                            <a href="javascript:void(0)" class="change_agree" onclick="old.agree_exchange_type('{$good_list.id}','from',{$user.id},'{$good_list.exchange_log.from_deposit}')">同意</a>
                            <a href="#" class="change_disagree" data-toggle="modal" data-target="#exMethodModal" data-exchange-id="{$good_list.id}" data-user-type="from" data-other-deposit="{$good_list.exchange_log.to_deposit}">更换交换方式</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 11}
                    <footer class="change_foot clearfix">
                        <span>您已选择交换方式为私下交换，请等待对方选择。</span>
                        <div class="change_foot_body">
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_agree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 13}
                    <footer class="change_foot clearfix">
                        <span>您已选择交换方式为担保交换并且担保金额¥{$good_list.exchange_log.from_deposit},请等待对方选择。</span>
                        <div class="change_foot_body">
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_agree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 15}
                    <footer class="change_foot clearfix">
                        <span>都同意私下交换了，愉快的去约时间见面吧！</span>
                        <div class="change_foot_body">
                            <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.finish_exchange(this,'{$good_list.id}','from')">完成交换</a>
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_disagree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 17}
                    <footer class="change_foot clearfix">
                        <span>您已同意{$good_list.to_user_data.user_name}提出的担保方式，请编辑地址。</span>
                        <div class="change_foot_body">
                            {if $user_consignee}
                                {foreach from=$user_consignee item=c_list key=keyd}
                                    {if $c_list.is_default eq '1'}
                                    <span style="color: #b3b3b3;">默认地址:{$c_list.consignee}&nbsp;&nbsp;{$c_list.mobile}&nbsp;&nbsp;{$c_list.province}{$c_list.city}{$c_list.address}</span>
                                    <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.set_exchange_consignee('{$good_list.id}','{$c_list.id}','from')">使用默认地址</a>
                                    {/if}
                                {/foreach}
                                <a href="#" class="change_disagree no_margin" data-toggle="modal" data-target="#consigneeModal" data-exchange-id="{$good_list.id}" data-user-type="from">编辑我的地址</a>
                            {else}
                                <a href="{url_wap r="old#edit_consignee"}"  class="change_agree no_margin">
                            编辑我的地址</a>
                            {/if}
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 26}
                    <footer class="change_foot clearfix">
                        <span>对方已填写了收件地址，为保证交换进度，请您快编辑地址。</span>
                        <div class="change_foot_body">
                            {if $user_consignee}
                            {foreach from=$user_consignee item=c_list key=keyd}
                            {if $c_list.is_default eq '1'}
                            <span style="color: #b3b3b3;">默认地址:{$c_list.consignee}&nbsp;&nbsp;{$c_list.mobile}&nbsp;&nbsp;{$c_list.province}{$c_list.city}{$c_list.address}</span>
                            <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.set_exchange_consignee('{$good_list.id}','{$c_list.id}','from')">使用默认地址</a>
                            {/if}
                            {/foreach}
                            <a href="#" class="change_disagree no_margin" data-toggle="modal" data-target="#consigneeModal" data-exchange-id="{$good_list.id}" data-user-type="from">选择收货地址</a>
                            {else}
                            <a href="{url_wap r="old#edit_consignee"}"  class="change_agree no_margin">
                            编辑我的地址</a>
                            {/if}
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 21}
                    <footer class="change_foot clearfix">
                        <span>您的地址已经编辑完成，正在等待对方填写地址信息（为保证交换进度，请提醒对方编辑地址）。</span>
                        <div class="change_foot_body">
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_agree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 23}
                    <footer class="change_foot clearfix">
                        <!--<span>对方收货地址：{$good_list.exchange_log.to_consignee}&nbsp;&nbsp;{$good_list.exchange_log.to_mobile}&nbsp;&nbsp;{$good_list.exchange_log.to_province}{$good_list.exchange_log.to_city}{$good_list.exchange_log.to_address}</span>-->
                        <script>expressList['{$good_list.id}'] = {name:'{$good_list.exchange_log.to_consignee}',address:'{$good_list.exchange_log.to_mobile}&nbsp;&nbsp;{$good_list.exchange_log.to_province}{$good_list.exchange_log.to_city}{$good_list.exchange_log.to_address}'}</script>
                        <span>对方已填写收件地址，请尽快为对方发货并填写物流单。</span>
                        <!--<span>交换方式：担保交易保证金（{$good_list.exchange_log.to_deposit}RMB）{$good_list.exchange_log.to_express}ps:这里显示我填写的物流信息</span>-->
                        <span style="color: #b3b3b3;">对方地址：{$good_list.exchange_log.to_consignee}&nbsp;&nbsp;{$good_list.exchange_log.to_mobile}&nbsp;&nbsp;{$good_list.exchange_log.to_province}{$good_list.exchange_log.to_city}{$good_list.exchange_log.to_address}</span>
                        <div class="change_foot_body">
                            <a href="#" class="change_agree" data-target="#expressModal" data-exchange-id="{$good_list.id}" data-user-type="from"  data-toggle="modal">填写物流信息</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 25}
                    <footer class="change_foot clearfix">
                        <script>expressList['{$good_list.id}'] = {name:'{$good_list.exchange_log.to_consignee}',address:'{$good_list.exchange_log.to_mobile}&nbsp;&nbsp;{$good_list.exchange_log.to_province}{$good_list.exchange_log.to_city}{$good_list.exchange_log.to_address}'}</script>
                        <span>对方已经给您发货了，赶快给对方发货吧！</span>
                        <!--<span>交换方式：担保交易保证金（{$good_list.exchange_log.to_deposit}RMB）{$good_list.exchange_log.to_express}ps:这里显示我填写的物流信息</span>-->
                        <span style="color: #b3b3b3;">对方地址：{$good_list.exchange_log.to_consignee}&nbsp;&nbsp;{$good_list.exchange_log.to_mobile}&nbsp;&nbsp;{$good_list.exchange_log.to_province}{$good_list.exchange_log.to_city}{$good_list.exchange_log.to_address}</span>
                        <div class="change_foot_body">
                            <a href="#" class="change_agree" data-target="#expressModal" data-exchange-id="{$good_list.id}" data-user-type="from"  data-toggle="modal">填写物流信息</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 27}
                    <footer class="change_foot clearfix">
                        <span>您已经填写物流单号，请提醒对方发货，以便完成交换。</span>
                        <div class="change_foot_body">
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_agree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 29}
                    <footer class="change_foot clearfix">
                        <span>交换方式:担保交换(¥{$good_list.exchange_log.to_deposit})&nbsp;&nbsp;物流信息:{$good_list.exchange_log.to_express}</span>
                        <span style="color: #b3b3b3;">请收到物品后尽快确认交换完成，以便系统早日退还保证金！</span>
                        <div class="change_foot_body">
                            <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.finish_exchange(this,'{$good_list.id}','from')">完成交换</a>
                            <!--<a href="#" class="change_disagree" data-target="#complaintModal" data-exchange-id="{$good_list.id}" data-user-type="from"  data-toggle="modal">投诉</a>-->
                            <!--<a href="tel:{$good_list.to_user_data.mobile}" class="change_disagree">拨打电话</a>-->
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 31}
                    <footer class="change_foot clearfix">
                        <span>您已确认收货，请提醒对方确认交换完成，以便系统尽快为您退还保证金。</span>
                        <div class="change_foot_body">
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_agree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 33}
                    <footer class="change_foot clearfix">
                        <span>已完成</span>
                        <div class="change_foot_body">
                            <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.del_exchange(this,'{$good_list.id}','from')">删除</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 35}
                    <footer class="change_foot clearfix">
                        <span>恭喜您完成交换！</span>
                        <div class="change_foot_body">
                            <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.del_exchange(this,'{$good_list.id}','from')">删除</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 37}
                    <footer class="change_foot clearfix">
                        <span>您已更改交换方式为担保交换并且担保金额¥{$good_list.exchange_log.from_deposit},请等待对方选择。</span>
                        <div class="change_foot_body">
                            <a href="{url_wap r="old#chat" p="id=$good_list.to_user_data.id"}" class="change_agree">与对方交谈</a>
                        </div>
                    </footer>
                    {/if}
                    {if $state eq 39}
                    <footer class="change_foot clearfix">
                        <span>交换方式:担保交换(¥{$good_list.exchange_log.to_deposit})&nbsp;&nbsp;物流信息:{$good_list.exchange_log.to_express}</span>
                        <span style="color: #b3b3b3;">对方已确认收货。请您在收到物品后尽快确认交换完成，以便系统尽快为您退还保证金。</span>
                        <div class="change_foot_body">
                            <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.finish_exchange(this,'{$good_list.id}','from')">完成交换</a>
                        </div>
                    </footer>
                    {/if}
                </article>
            {/foreach}
        </div>
<!-- To = me ; From = other-->
        <div class="tab-pane fade" id="my_exchange">
            <!--Empty-->
            {if $to_error}
            <section class="change_Panels"><div class="exchange_empty"><span>{$to_error}</span><a href="{url_wap r="old"}">看看有哪些好玩的东东先</a></div></section>
            {/if}
            <!--Not Empty-->
            {foreach from=$to_user_goods item=good_list key=keyd}
            {assign var=state value=$good_list.state_num}
            <article class="change_Panels">
                <header class="change_title clearfix">
                            <span class="change_title_left">
                                <img src="{function name="get_user_avatar" uid=$good_list.to_user_data.id type="middle"}" "" border=0 width=15 class="img-circle">
                                <!--我的名字-->
                                {$good_list.to_user_data.user_name}-HUAN单号:{$good_list.id}-状态：{$state}
                            </span>
                    <span class="change_title_right">{$good_list.create_time}</span>
                </header>
                <div class="change_body clearfix">
                    <div class="change_body1">
                        {foreach from=$good_list.to_images_data.list item=img_list key=keyd}
                        {if $img_list.is_top eq 1}
                        <!--获取封面-->
                        <a href="{url_wap r="old#detail" p="id=$img_list.goods_id"}"><img src="{$TMPL}/old/images/holder.png" original="{$img_list.url}" border=0 width=100% class="lazy"></a>
                        {/if}
                        {/foreach}
                    </div>
                    <div class="change_body2">
                        <img src="{$TMPL}/old/images/change.png" border=0 width=100%>
                    </div>
                    <div class="change_body3">
                        <!--想要交换的对方的物品图片-->
                        {foreach from=$good_list.from_images_data.list item=img_list key=keyd}
                        {if $img_list.is_top eq 1}
                        <!--获取封面-->
                        <a href="{url_wap r="old#detail" p="id=$img_list.goods_id"}"><img src="{$TMPL}/old/images/holder.png" original="{$img_list.url}" border=0 width=100% class="lazy"></a>
                        {/if}
                        {/foreach}
                    </div>
                </div>
                <!--各种状态开始-->
                {if $state eq 2}
                <footer class="change_foot clearfix">
                    <span>您已请求交换，请等待对方响应。</span>
                    <div  class="change_foot_body">
                        <a href="{url_wap r="old#chat" p="id=$good_list.from_user_data.id"}" class="change_agree">与对方交谈</a>
                    </div>
                </footer><!--State 2-->
                {/if}
                {if $state eq 4}
                <footer class="change_foot clearfix">
                    <span>抱歉，{$good_list.from_user_data.user_name}和别人交换了，点击“确认”去看看其他物品吧！</span>
                    <div  class="change_foot_body">
                        <a href="#" class="change_agree" onclick="old.del_exchange(this,{$good_list.id},'to')">确认</a><!--此时应该删除本条log-->
                    </div>
                </footer><!--State 4-->
                {/if}
                {if $state eq 6}
                <footer class="change_foot clearfix">
                    <span>抱歉，{$good_list.from_user_data.user_name}拒绝您的交换申请，点击“确认”去看看其他物品吧！</span>
                    <div  class="change_foot_body">
                        <a href="#" class="change_agree" onclick="old.del_exchange(this,{$good_list.id},'to')">确认</a><!--此时应该删除本条log-->
                    </div>
                </footer><!--State 6-->
                {/if}
                {if $state eq 8}
                <div class="change_progess clearfix">
                    <span >您还有{$good_list.from_rest_time.time}完成确认，quickly ~</span>
                    <div class="progress progress-striped process_height">
                        <div class="progress-bar progress-bar-info" role="progressbar"
                             aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"
                             style="width: {$good_list.from_rest_time.percent}%;">
                        </div>
                    </div>
                </div>
                <footer class="change_foot clearfix">
                    <span>{$good_list.from_user_data.user_name}同意您的交换申请，请选择交换方式。</span>
                    <div  class="change_foot_body">
                        <a href="#" class="change_agree" data-toggle="modal" data-target="#exMethodModal" data-exchange-id="{$good_list.id}" data-user-type="to">
                            选择交换方式
                        </a>
                    </div>
                </footer><!--State 8-->
                {/if}
                {if $state eq 10}
                <footer class="change_foot clearfix">
                    <span>您已选择交换方式为私下交换，请等待对方选择。</span><!--B选择了交换方式-->
                    <div class="change_foot_body">
                        <a href="{url_wap r="old#chat" p="id=$good_list.from_user_data.id"}" class="change_agree">与对方交谈</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 12}
                <footer class="change_foot clearfix">
                    <span>您已选择交换方式为担保交换并且担保金额¥{$good_list.exchange_log.to_deposit}，请等待对方选择。</span><!--B选择了交换方式-->
                    <div class="change_foot_body">
                        <a href="{url_wap r="old#chat" p="id=$good_list.from_user_data.id"}" class="change_agree">与对方交谈</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 14}
                <footer class="change_foot clearfix">
                    <span>{$good_list.from_user_data.user_name}想将交换方式修改为私下交换，是否同意？</span>
                    <div class="change_foot_body">
                        <a href="javascript:void(0)" class="change_agree" onclick="old.agree_exchange_type('{$good_list.id}','to',{$user.id},'{$good_list.exchange_log.to_deposit}')">同意</a>
                        <a href="javascript:void(0)" class="change_disagree" onclick="old.giveup_exchange(this,'{$good_list.id}','to')">放弃交换</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 16}
                <footer class="change_foot clearfix">
                    <span>{$good_list.from_user_data.user_name}想将交换方式修改为担保交换并且保证金为¥{$good_list.exchange_log.from_deposit}和您交换物品，是否同意？</span>
                    <div class="change_foot_body">
                        <a href="javascript:void(0)" class="change_agree" onclick="old.agree_exchange_type('{$good_list.id}','to',{$user.id},'{$good_list.exchange_log.to_deposit}')">同意</a>
                        <a href="javascript:void(0)" class="change_agree" onclick="old.giveup_exchange(this,'{$good_list.id}','to')">放弃交换</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 18}
                <footer class="change_foot clearfix">
                    <span>都同意线下交换了，愉快的去约时间见面吧！</span>
                    <div class="change_foot_body">
                        <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.finish_exchange(this,'{$good_list.id}','to')">完成交换</a>
                        <a href="{url_wap r="old#chat" p="id=$good_list.from_user_data.id"}" class="change_disagree">与对方交谈</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 20}
                <footer class="change_foot clearfix">
                    <span>您已同意{$good_list.from_user_data.user_name}提出的担保方式，请编辑地址。</span>
                    <div class="change_foot_body">
                        {if $user_consignee}
                        {foreach from=$user_consignee item=c_list key=keyd}
                        {if $c_list.is_default eq '1'}
                        <span style="color: #b3b3b3;">默认地址:{$c_list.consignee}&nbsp;&nbsp;{$c_list.mobile}&nbsp;&nbsp;{$c_list.province}{$c_list.city}{$c_list.address}</span>
                        <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.set_exchange_consignee('{$good_list.id}','{$c_list.id}','to')">使用默认地址</a>
                        {/if}
                        {/foreach}
                        <a href="#" class="change_disagree no_margin" data-toggle="modal" data-target="#consigneeModal" data-exchange-id="{$good_list.id}" data-user-type="to">选择收货地址</a>
                        {else}
                        <a href="{url_wap r="old#edit_consignee"}"  class="change_agree no_margin">
                        编辑我的地址</a>
                        {/if}
                    </div>
                </footer>
                {/if}
                {if $state eq 22}
                <footer class="change_foot clearfix">
                    <span>对方已填写了收件地址，为保证交换进度，请您快编辑地址。</span>
                    <div class="change_foot_body">
                        {if $user_consignee}
                        {foreach from=$user_consignee item=c_list key=keyd}
                        {if $c_list.is_default eq '1'}
                        <span style="color: #b3b3b3;">默认地址:{$c_list.consignee}&nbsp;&nbsp;{$c_list.mobile}&nbsp;&nbsp;{$c_list.province}{$c_list.city}{$c_list.address}</span>
                        <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.set_exchange_consignee('{$good_list.id}','{$c_list.id}','to')">使用默认地址</a>
                        {/if}
                        {/foreach}
                        <a href="#" class="change_disagree no_margin" data-toggle="modal" data-target="#consigneeModal" data-exchange-id="{$good_list.id}" data-user-type="to">选择收货地址</a>
                        {else}
                        <a href="{url_wap r="old#edit_consignee"}"  class="change_agree no_margin">
                        编辑我的地址</a>
                        {/if}
                    </div>
                </footer>
                {/if}
                {if $state eq 24}
                <footer class="change_foot clearfix">
                    <span>您的地址已经编辑完成，正在等待对方填写地址信息（为保证交换进度，请提醒对方编辑地址）。</span>
                    <div class="change_foot_body">
                        <a href="{url_wap r="old#chat" p="id=$good_list.from_user_data.id"}" class="change_agree">与对方交谈</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 26}
                <footer class="change_foot clearfix">
                    <script>expressList['{$good_list.id}'] = {name:'{$good_list.exchange_log.from_consignee}',address:'{$good_list.exchange_log.from_mobile}&nbsp;&nbsp;{$good_list.exchange_log.from_province}{$good_list.exchange_log.from_city}{$good_list.exchange_log.from_address}'}</script>
                    <span>对方已填写收件地址，请尽快为对方发货并填写物流单。</span>
                    <span style="color: #b3b3b3;">对方地址：{$good_list.exchange_log.from_consignee}&nbsp;&nbsp;{$good_list.exchange_log.from_mobile}&nbsp;&nbsp;{$good_list.exchange_log.from_province}{$good_list.exchange_log.from_city}{$good_list.exchange_log.from_address}</span>
                    <div class="change_foot_body">
                        <a href="#" class="change_agree" data-target="#expressModal" data-exchange-id="{$good_list.id}" data-user-type="to" data-toggle="modal">填写物流信息</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 28}
                <footer class="change_foot clearfix">
                    <script>expressList['{$good_list.id}'] = {name:'{$good_list.exchange_log.from_consignee}',address:'{$good_list.exchange_log.from_mobile}&nbsp;&nbsp;{$good_list.exchange_log.from_province}{$good_list.exchange_log.from_city}{$good_list.exchange_log.from_address}'}</script>
                    <span>对方已经给您发货了，赶快给对方发货吧！</span>
                    <span style="color: #b3b3b3;">对方地址：{$good_list.exchange_log.from_consignee}&nbsp;&nbsp;{$good_list.exchange_log.from_mobile}&nbsp;&nbsp;{$good_list.exchange_log.from_province}{$good_list.exchange_log.from_city}{$good_list.exchange_log.from_address}</span>
                    <div class="change_foot_body">
                        <a href="#" class="change_agree" data-target="#expressModal" data-exchange-id="{$good_list.id}" data-user-type="to" data-toggle="modal">填写物流信息</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 30}
                <footer class="change_foot clearfix">
                    <span>您已经填写物流单号，请提醒对方发货，以便完成交换。</span>
                    <div class="change_foot_body">
                        <a href="{url_wap r="old#chat" p="id=$good_list.from_user_data.id"}" class="change_agree">与对方交谈</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 32}
                <footer class="change_foot clearfix">
                    <span>交换方式:担保交换(¥{$good_list.exchange_log.to_deposit})&nbsp;&nbsp;物流信息:{$good_list.exchange_log.from_express}</span>
                    <span style="color: #b3b3b3;">请收到物品后尽快确认交换完成，以便系统早日退还保证金！</span>
                    <div class="change_foot_body">
                        <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.finish_exchange(this,'{$good_list.id}','to')">完成交换</a>
                        <!--<a href="#" class="change_disagree" data-target="#complaintModal" data-exchange-id="{$good_list.id}" data-user-type="from"  data-toggle="modal">投诉</a>-->
                    </div>
                </footer>
                {/if}
                {if $state eq 34}
                <footer class="change_foot clearfix">
                    <span>您已确认收货，请提醒对方确认交换完成，以便系统尽快为您退还保证金。</span>
                    <div class="change_foot_body">
                        <a href="{url_wap r="old#chat" p="id=$good_list.from_user_data.id"}" class="change_agree">与对方交谈</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 36}
                <footer class="change_foot clearfix">
                    <span>已完成</span>
                    <div class="change_foot_body">
                        <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.del_exchange(this,'{$good_list.id}','to')">删除</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 38}
                <footer class="change_foot clearfix">
                    <span>恭喜您完成交换！</span>
                    <div class="change_foot_body">
                        <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.del_exchange(this,'{$good_list.id}','to')">删除</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 40}
                <footer class="change_foot clearfix">
                    <span>{$good_list.from_user_data.user_name}更改交换方式为担保交换并且担保金额¥{$good_list.exchange_log.from_deposit},是否同意？(同意后会为您退还之前所缴纳保证金)</span>
                    <div class="change_foot_body">
                        <!--<a href="javascript:void(0)" class="change_agree" onclick="old.re_add_order('{$good_list.id}','to',{$user.id},'{$good_list.exchange_log.from_deposit}')">同意</a>-->
                        <a href="#" class="change_agree no_margin" data-toggle="modal" data-target="#paymentModal" data-exchange-id="{$good_list.id}" data-user-id="{$user.id}" data-deposit="{$good_list.exchange_log.from_deposit}">同意</a>
                        <a href="javascript:void(0)" class="change_disagree" onclick="old.giveup_exchange(this,'{$good_list.id}','to')">放弃交换</a>
                    </div>
                </footer>
                {/if}
                {if $state eq 42}
                <footer class="change_foot clearfix">
                    <span>交换方式:担保交换(¥{$good_list.exchange_log.to_deposit})&nbsp;&nbsp;物流信息:{$good_list.exchange_log.from_express}</span>
                    <span style="color: #b3b3b3;">对方已确认收货。请您在收到物品后尽快确认交换完成，以便系统尽快为您退还保证金。</span>
                    <div class="change_foot_body">
                        <a href="javascript:void(0)" class="change_agree no_margin" onclick="old.finish_exchange(this,'{$good_list.id}','to')">完成交换</a>
                    </div>
                </footer>
                {/if}
            </article>
            {/foreach}
        </div>
        </div><!--myTabContent end-->
    </div>
</div>
{include file="old/modals.html"}
{include file="old/old_footer.html"}
<script>
    $(function () {
        $('[data-toggle="popover"]').popover();

        var hash = location.hash;
        $tab = hash?$('#myTab li a[href="'+hash+'"]'):$('#myTab li:eq(0) a');
        $tab.tab('show');

        $('#myTab li>a').on("shown.bs.tab", function(e) {
//            console.log('d')
            var id = $(e.target).attr("href").substr(1);
            window.location.hash = id;
            $('html, body').animate({scrollTop: 0}, 300);
        });
        /*修改时间戳格式*/
        $(".change_title_right").each(function(){
            var time = $(this).html();
            var newDate = new Date();
            newDate.setTime(time * 1000);
//            console.log(newDate.toLocaleDateString());
            $(this).html(newDate.toLocaleDateString());
        })
//        console.log("{$good_list.id}")
        //设置交换方式弹出
        $('#exMethodModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var parent = button.parents('.change_foot');
            var exchange_id = button.data('exchange-id');
            var user_type = button.data('user-type');
            var other_deposit = button.data('other-deposit');
//            var other_deposit = 400;
            var p = {exchange_id:exchange_id,user_type:user_type};
            var modal = $(this);
            var submit = $('#exMethodFormSubmit');
            var form = $('#exMethodForm');
            var onlineRadio = $('#change_type_online'),offlineRadio = $('#change_type_offline');
            var offlinePart =  $('.change_type_offline_bottom');
//            console.log(other_deposit);
            onlineRadio.on(EVENT_TYPE,function(){
                if(this.checked){
                    if(other_deposit==undefined || other_deposit==0){
                        offlinePart.find('.change_modal_body_bottom_span').hide();
                    }else{
                        offlinePart.find('.no_top>em').html(other_deposit)
                    }
                    offlinePart.slideDown();
                };
            });
            offlineRadio.on(EVENT_TYPE,function(){
                if(this.checked){
                    offlinePart.slideUp();
                };
            })
            submit.on(EVENT_TYPE,function(){
                var formP = form.serializeArray();
                //线下交易：1，线上交易：2
                if(formP[0].name=='change_type'&&formP[0].value==1){
                    //线下交换
                    p.change_type = 1;
                    p.deposit = 0;
                }else if(formP[0].name=='change_type'&&formP[0].value==2){
                    p.change_type = 2;
                    p.deposit = formP[1].value;
                }
                if(p.change_type==2&& p.deposit==0){
                    var d = $.showErr('请填写保证金。')
                    return false;
                }else if(p.deposit<parseFloat(offlinePart.find('.no_top>em').html())){
                    var d = $.showErr('保证不能少于对方。');
                    return false;
                }else if(p.deposit>9999){
                    var d = $.showErr('抱歉，系统支持保证金上限9999元。');
                    return false;
                }else{
                    //如果是线下：设置交换方式
                    if(p.change_type==1){
                        old.set_exchange_type(p,function(json){
                            if(p.change_type==1){
                                var d = new dialog('设置成功！','light',function(){});
                                setTimeout(function(){
                                    window.location.reload()
                                },3000)
                                return;
                            }
                        },function(json){
                            var d = new dialog(json.data.msg,'light',function(){})
                        });
                    }else{
                    //如果是线上：先交保证金
                        modal.modal('hide');
                        p.user_id = user_id;
                        localStorage.setItem("nowPayInfo", JSON.stringify(p));
                        $('#paymentModal').modal('show');
                        return;
                    }
                }
                submit.off();
            });

            /*$(this).on('hidden.bs.modal', function (event) {

             })*/
        })
        /*选择地址*/
        $('#consigneeModal').on('show.bs.modal', function (event) {
            var consginee_id = $('input[name="consignee"]:checked').val();
            var button = $(event.relatedTarget);
            var exchange_id = button.data('exchange-id');
            var user_type = button.data('user-type');
            var p = {exchange_id:exchange_id,user_type:user_type,consginee_id:consginee_id};
            $('#consigneeModalBtn').on(EVENT_TYPE, function (event) {
                console.log(p);
                if(consginee_id==''||consginee_id==undefined){
                    var d = new dialog('｀没设置成功，是不是没选上？重新选一下吧｀','light',function(){})
                    return false;
                }
                old.set_exchange_consignee(exchange_id,consginee_id,user_type);
            })


        })

        /*填写物流信息*/
        $('#expressModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var exchange_id = button.data('exchange-id');
            var user_type = button.data('user-type');
            var consignee_info = expressList[exchange_id];
            $('.consignee_name').html(consignee_info.name);
            $('.consignee_address').html(consignee_info.address);

            $('#expressSubmit').on(EVENT_TYPE,function(){
                var express = $('input[name="express"]').val(),
                    company = $('input[name="company"]').val(),
                    p = {exchange_id:exchange_id,user_type:user_type,express:(company+express)};
                if(express==""||company==""){
                    var d = new dialog('请填写快递公司和单号','light',function(){});
                    return false;
                };
                old.set_exchange_express(p,function(json){
                    window.location.reload();
                })
            });
        })
        //支付事件
        $('#paymentModal').on('show.bs.modal',function(event){
            var button = $(event.relatedTarget);
            if(button.length !== 0){
                var exchange_id = button.data('exchange-id');
                var user_id = button.data('user-id');
                var deposit = button.data('deposit');
                var pay_info = {exchange_id:exchange_id,user_id:user_id,change_type: 2, deposit:deposit};
            }else{
                var pay_info = JSON.parse(localStorage.getItem("nowPayInfo"));
            }
            $('.pay_wx_btn').on(EVENT_TYPE,function(){
                var payment_id = $(this).data('payment-id');
                pay_info.payment_id = payment_id;pay_info.bank_id = 0;
                old.add_order(pay_info);
                console.log(pay_info);
//                $('.pay_wx_btn').off();
            });

        })
    });
</script>


</body>
<html>