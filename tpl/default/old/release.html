{include file="old/old_header.html"}
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/select.css"/>
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/issue.css?1"/>
<div id="nav">
    <div class="top" >
        <div class="top_left">
            <!--<a href="{url_wap r="old"}"><img src="{$TMPL}/old/images/exit.png"></a>-->
            <a href="javascript:window.history.go(-1)"><img src="{$TMPL}/old/images/exit.png"></a>
        </div>
        <div class="top_center">{$page_title}</div>
        <div class="top_right">
            <a href="javascript:void(0)" id="submit">确认</a>
        </div>
    </div>
</div>
<div class="issuecontain">
    <div class="issue">
        <div class="issue_add str" for="img_0">
            <div class="issue_add_div">
                <!--添加图片样式的开始-->
                <img src="{$TMPL}/old/images/add_bg.png" class="backdrop" width=100% id="preview_area">
                <input type="file" hidden="hidden" name="img_0" class="issue_upload_input" id="img_0">
                <!--添加图片样式的结束-->
            </div>
        </div>
    </div>
    <div class="filter">
        <input hidden="hidden" type="checkbox" value="1" name="is_cover" id="is_cover" CHECKED><label id="setCoverBtn" for="radio_img_1">设为封面</label>
        <input hidden="hidden" type="checkbox" value="1" name="is_filter" id="is_filter" CHECKED><label for="is_filter" id="filterBtn">滤镜效果</label>
    </div><!--<a href="#" class="filter">&lt;!&ndash;<img src="{$TMPL}/old/images/filter_hover.png" border=0 width=10>&ndash;&gt;滤镜效果</a>-->
</div>
<!-- 缩略图 -->
<div class="issue_contain clearfix">
    <ul class="select-list">
        <li>
            <figure style="background-image:url({$TMPL}/old/images/add_good.png)">
                <!--<input type="file" hidden="hidden" name="img_1" class="issue_upload_input" id="img_1">-->
                <i>封面</i>
            </figure>
        </li>
    </ul>
</div>
<!-- 文本框 -->
<div class="issue_title">
    <input type="text" value="" name="name" class="issue_title_input gray" placeholder="请填写标题：标题不超过14个字(必填)">
</div>
<div class="issue_des">
    <textarea class="issue_des_textarea" name="info" rows=5 placeholder="请填写物品描述：物品描述不超过500个字(必填)"></textarea>
</div>

{include file="old/old_inc_footer.html"}
<script type="text/javascript" src="{$TMPL}/js/ajaxupload.js"></script>
<script>
    var release = {cover:'0'};
    release.uploadFile = function(file_id,successFun,errorFun){
        $(document).on('change',"input[name='"+file_id+"']",function(){
//            console.log(file_id);
            $('#loading').show();
            var files = $('input[name="'+file_id+'"]').prop('files');
            var index = parseInt(file_id.substr(4,5));
            if(!tools.getFileType(file_id)){
                $('#loading').hide();
                $.showErr('请选择有效的图片文件上传！',function(){});return false;
            };
            $.ajaxFileUpload({
                        url:APP_ROOT_ORA+"/olddata.php?act=add_goods_img&user_id={$user.id}&img_num="+index,
                        secureuri:false,
                        fileElementId:file_id,
                        dataType: 'json',
                        success: function (data){
                            $('#loading').hide();
                            if(data.error==0){
//                                alert(data.data.data);
                                successFun && successFun(data);
                                //否则会出现重复绑定上传的情况
                                $('form[name="jUploadForm'+file_id+'"]').remove();
                                $('iframe[name="jUploadFrame'+file_id+'"]').remove();
                            }else{
//                                alert(data.data.data);
                                errorFun && errorFun(data);
                            }
                        },
                        error: function (data, status, e){
                            console.log(e.message);
                        }
                    }
            );

        });
        $('input[name="'+file_id+'"]').off('change');
    }

    release.checkForm = function(p){
         if(p.name==""){$.showErr('请输入标题',function(){});return false;}
         if(p.info==""){$.showErr('请输入物品描述',function(){});return false;}
         if(p.name.length>50){$.showErr('标题太长',function(){});return false;}
         if(p.info.length>1000){$.showErr('物品描述太啰嗦，请精简物品描述',function(){});return false;}
         if(p.info.length<10){$.showErr('物品描述太简短，请再详细描述您的物品',function(){});return false;}
         if(p.images.length==0){$.showErr('请添加图片',function(){});return false;}
         if(p.top_img_num==""||p.top_img_num==undefined){$.showErr('请选择封面图片',function(){});return false;}
        return true;
     }
</script>
<script>
    var refer = document.referrer;
//console.log(refer)
    $(function(){
        if(refer==''){
            $('.top_left>a').click(function(e){
                if ( e && e.preventDefault ){
                    e.preventDefault();
                }else{
                    window.event.returnValue = false;
                }
                window.location.replace(APP_ROOT+'?ctl=old');
            });
        }
        var $preview = $('#preview_area'),//预览图
                $preview_container = $('.issue_add'),//上传封面时用到
                $file_box = $('.select-list'),//缩略图区
                $set_cover_btn = $('#setCoverBtn'),//设置封面的label
                $is_cover = $('#is_cover'),//当前预览是否为封面的checkbox
                $filter = $('input[name="is_filter"]'),//滤镜选择
                $submit = $('#submit');
         /*提交事件*/
        $submit.on(EVENT_TYPE,function(){
             var is_filter = $filter.is(':checked'),
             name = $('input[name="name"]').val(),
             info = $('.issue_des_textarea').val(),
             top_img_num =$('input[name="top_img_num"]:checked').val(),
             images = [],
             catchList = CachedFileBox.getFileItem(),
             card_state = "{$card_state}";
//console.log(catchList);
            if(catchList.length){
                for(var i=0;i<catchList.length;i++){
                    images.push(catchList[i].src);
                }
            }
            info = ((info.replace(/<(.+?)>/gi,"&lt;$1&gt;")).replace(/ /gi,"&nbsp;")).replace(/\n/gi,"<br>");
            var p = {name:name,info:info,top_img_num:top_img_num,images:images.toString(),is_filter:is_filter};
            if(release.checkForm(p)){
//                console.log(p);return;
                old.add_goods(p,parseInt(card_state),user_id);
            }

         });
        //是否滤镜
        $filter.on(EVENT_TYPE,function(){
            var is_filter = $(this).is(':checked');
            if(is_filter){
                $preview.addClass('backdrop');
            }else{
                $preview.removeClass('backdrop');
            }
        })
        /*绑定第一次封面上传图片的事件*/
        $preview_container.on(EVENT_TYPE,function(){
            var _this = $(this),id = _this.attr('for');
//            alert('点击上传');
            release.uploadFile(id,function(json){
                _this.removeClass('str').removeAttr('for');//去掉添加封面文字
                release.cover = $("#img_0").clone();
                $("#img_0").remove();
                $preview.attr('src','.'+json.data)//.addClass('pulse');//加着玩的

                //将第一个加入数组
                CachedFileBox.attachFileBox('img_1',$preview[0].src,1);
                /*输出缩略图item*/
                setTimeout(function(){
                    $file_box.html(CachedFileBox.writeHtmlItem()).addClass('fadeInDown').show();
                },100)
            },function(json){
                var msg = '没找到上传的图片＝。＝';
                if(json.error==-1){
                    msg = '上传出错了＝。＝'
                }
                $.showErr(msg,function(){});return false;
            })
        })
        /*小缩略图的事件处理*/
        $file_box.on(EVENT_TYPE,'li',function(e){
            var _this = $(this),inp = _this.find('input[type="file"]'),id=inp.prop('id');

//            console.log(e.target.nodeName);
            /*点击缩略图出现预览&获取封面选中状态*/
            if(e.target.nodeName=='FIGURE'||(e.target.nodeName=='I'&&(!$(e.target).hasClass('delItem')))){

                var _id = _this.data('index');

                var item = CachedFileBox.getFileItem(_id);
//                console.log(CachedFileBox.getFileItem());
//                console.log(CachedFileBox.getFileItem(_id));

                $preview.attr('src',item.src);
                //设置该图片的封面选中状态
                $set_cover_btn.prop('for','radio_'+item.id);
                $is_cover.prop('checked',(item.is_top==1));
                //<input type="radio" name="top_img_num" value="0" hidden="hidden" id="img_1">
            }
            /*接收到delItem按钮：删除该缩略图*/
            if(e.target.nodeName=='I'&&$(e.target).hasClass('delItem')){
                var btn = $(e.target),index = btn.data('index');
                var item = CachedFileBox.getFileItem(index);
                if($preview[0].src==item.src){
                    if(index>0){
                        var pre_item = CachedFileBox.getFileItem(index-1);
                        $preview[0].src = pre_item.src;
                        //设置该图片的封面选中状态
                        $set_cover_btn.prop('for','radio_'+pre_item.id);
                        $is_cover.prop('checked',(pre_item.is_top==1));
                    }else{
                        $preview[0].src = "{$TMPL}/old/images/add_bg.png";
                        $preview_container.find('.issue_add_div').append(release.cover);

                    }
                }
                CachedFileBox.clearFileBox(index);
                $file_box.html(CachedFileBox.writeHtmlItem()).removeClass('fadeInDown');
//                console.log(CachedFileBox.getFileItem());
                return false;
            }
            /*其他区域：上传*/
            //没有input的不上传
            if(inp.size()==0){return false};
            if(e.target.nodeName=='INPUT'){
                release.uploadFile(id,function(json){
                    $preview.attr('src','.'+json.data);
                    CachedFileBox.attachFileBox(id,$preview[0].src,0);
                    $file_box.html(CachedFileBox.writeHtmlItem());
                    //当前label改为该图片对应的radio的id
                    $set_cover_btn.prop('for','radio_'+id);
                    //将设为封面按钮恢复为未选中
                    $is_cover.prop('checked',false);
                },function(json){
                    $file_box.html(CachedFileBox.writeHtmlItem());
                    var msg = '没找到上传的图片＝。＝';
                    if(json.error==-1){
                        msg = '上传出错了＝。＝'
                    }
                    $.showErr(msg,function(){});return false;

                })
            }

        });
        //点选设置封面按钮事件
        $set_cover_btn.on(EVENT_TYPE,function(){
            var id = $(this).attr('for'),
                    $for_cover_radio = $('#'+id),
                    for_cover_id = $for_cover_radio.parents('li').data('index'),
                    item = CachedFileBox.setFileItemIsTop(for_cover_id,(!$is_cover.prop('checked')));
//            console.log(for_cover_id);
//            console.log(item);
            if($is_cover.prop('checked')) return;
            //设置该id的图片为封面
            $for_cover_radio.prop('checked',(item.is_top==1));
            //勾选已选中
            $is_cover.prop('checked',(item.is_top==1));
        });

        /*缩略图的array*/
        var CachedFileBox = (function(){
            var cache = [];//保留在内存中
            return {
                attachFileBox : function(id,src,is_top){
                    var fsb = this.creatImageItem(id,src,is_top);//新建
                    cache.push(fsb);//更新缓存
                    if(cache.length > 6){
                        cache.pop();
                    }
                    return fsb;
                },
                clearFileBox : function(id){
                    cache.splice(id,1);
                },
                creatImageItem : function(id,src,is_top){
                    return {id:id,src:src,is_top:is_top};
                },
                writeHtmlItem:function(){
                    var str = '';

                    for(var i=0;i<cache.length;i++){
                        str += '<li data-index="'+i+'"><figure style="background-image:url('+cache[i].src+')">';
//                        str += '<input type="file" hidden="hidden" name="'+id+'" class="issue_upload_input" id="'+id+'">';
                        if(cache[i].is_top==1){
                            str += '<input type="radio" name="top_img_num" value="'+i+'" hidden="hidden" id="radio_'+cache[i].id+'" checked><i>封面</i>';
                        }else{
                            str += '<input type="radio" name="top_img_num" value="'+i+'" hidden="hidden" id="radio_'+cache[i].id+'"><i>封面</i>';
                        }
                        str += '</figure><i class="delItem" data-index="'+i+'"></i></li>';
                    }
                    if(cache.length< 6){
                        str += '<li><figure style="background-image:url({$TMPL}/old/images/add_good.png)" data-index="'+(cache.length+1)+'">';
                        str += '<input type="file" hidden="hidden" name="img_'+(cache.length+1)+'"  class="issue_upload_input" id="img_'+(cache.length+1)+'">';
                    }
//                    console.log(str);
                    return str;
                },
                getFileItem:function(id){
//                    return cache[id];
//                    console.log(id)
                    return id!==undefined?cache[id]:cache;
                },
                setFileItemIsTop:function(id,is_top){
                    for(var i=0;i<cache.length;i++){
                        cache[i].is_top = 0;
                    }
                    cache[id].is_top = is_top;
                    return cache[id];
                }
            };
        })();
    })
</script>
</body>
<html>