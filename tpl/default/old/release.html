{include file="old/old_header.html"}
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/select.css"/>
<link rel="stylesheet" type="text/css" href="{$TMPL}/old/css/issue.css"/>
<div id="nav">
 <div class="top" >
  <div class="top_left">
      <!--<a href="{url_wap r="old"}"><img src="{$TMPL}/old/images/exit.png"></a>-->
      <a href="javascript:window.history.go(-1)"><img src="{$TMPL}/old/images/exit.png"></a>
  </div>
  <div class="top_center">{$page_title}</div>
  <div class="top_right">
       <a href="javascript:void(0)" id="submit">确认</a>
  </div>
</div>
</div>
  <form id="releaseFrom">
       <div class="issuecontain">
              <div class="issue">
                <label class="issue_add str" for="img_0">
                    <div class="issue_add_div">
                     <!--添加图片样式的开始-->
                        <img src="{$TMPL}/old/images/add_bg.png" class="backdrop" width=100% id="preview_area">
                        <input type="file" hidden="hidden" name="img_0" class="issue_upload_input" id="img_0">
                       <!--添加图片样式的结束-->
                    </div>

                </label>
              </div>
              <div class="filter">
                  <input hidden="hidden" type="checkbox" value="1" name="is_cover" id="is_cover" CHECKED><label id="setCoverBtn" for="img_1">设为封面</label>
                  <input hidden="hidden" type="checkbox" value="1" name="is_filter" id="is_filter" CHECKED><label for="is_filter" id="filterBtn">滤镜效果</label>
                    </div><!--<a href="#" class="filter">&lt;!&ndash;<img src="{$TMPL}/old/images/filter_hover.png" border=0 width=10>&ndash;&gt;滤镜效果</a>-->
                </div>
               <div class="issue_contain clearfix">
                   <ul class="select-list">
                       <li>
                           <figure style="background-image:url({$TMPL}/old/images/add_good.png)">
                               <!--<input type="file" hidden="hidden" name="img_1" class="issue_upload_input" id="img_1">-->
                               <i>封面</i>
                           </figure>
                       </li>
                   </ul>
               </div>
               <div class="issue_title">
                 <input type="text" value="" name="name" class="issue_title_input gray" placeholder="请填写标题：标题不超过14个字">
               </div>
                <div class="issue_des">
                   <textarea class="issue_des_textarea" name="info" rows=5 placeholder="请填写物品描述：物品描述不超过140个字"></textarea>
               </div>
      </div>
  </form>
{include file="old/old_inc_footer.html"}
<script type="text/javascript" src="{$TMPL}/js/ajaxupload.js"></script>
<script>
    var release = {cover:'0',is_filter:1};
    release.uploadFile = function(file_id,successFun,errorFun){
        $(document).on('change',"input[name='"+file_id+"']",function(){
            $('#loading').show();
            var files = $('input[name="'+file_id+'"]').prop('files');
            var index = parseInt(file_id.substr(4,5));
            $.ajaxFileUpload({
                        url:APP_ROOT_ORA+"/olddata.php?act=add_goods_img&user_id={$user.id}&img_num="+index,
                        secureuri:false,
                        fileElementId:file_id,
                        dataType: 'json',
                        success: function (data){
                            $('#loading').hide();
                            console.log(data);
                                if(data.error==0){
                                successFun && successFun(data);
                                    //否则会出现重复绑定上传的情况
                                $('form[name="jUploadForm'+file_id+'"]').remove();
                                $('iframe[name="jUploadFrame'+file_id+'"]').remove();
                            }else{
                                errorFun && errorFun(data);
                            }
                        },
                        error: function (data, status, e){
                            console.log(e.message);
                        }
                    }
            );
            $('input[name="'+file_id+'"]').off('change');
        });
    }
</script>
<script>
    $(function(){
        var $preview = $('#preview_area'),
            $preview_container = $('.issue_add'),
            $file_box = $('.select-list'),
            $set_cover_btn = $('#setCoverBtn'),
            $is_cover = $('#is_cover');

        /*绑定第一次封面上传图片的事件*/
        $preview_container.on(EVENT_TYPE,function(){
            var _this = $(this),id = _this.attr('for');
            release.uploadFile(id,function(json){
                _this.removeClass('str').removeAttr('for');//去掉添加封面文字
                $("#img_0").remove();
                $preview.attr('src','.'+json.data)//.addClass('pulse');//加着玩的

                //将第一个加入数组
                CachedFileBox.attachFileBox('img_1',json.data,1);
                /*输出缩略图item*/
                setTimeout(function(){
                    $file_box.html(CachedFileBox.writeHtmlItem()).addClass('fadeInDown').show();
                },100)
            })
        })
        /*小缩略图的事件处理*/
        $file_box.on(EVENT_TYPE,'li',function(e){
            var _this = $(this),inp = _this.find('input[type="file"]'),id=inp.prop('id');

//            console.log(e.target.nodeName);
            /*点击缩略图出现预览&获取封面选中状态*/
            if(e.target.nodeName=='FIGURE'){
                var _id = _this.data('index');
                var item = CachedFileBox.getFileItem(_id);
                $preview.attr('src','.'+item.src);
                //设置该图片的封面选中状态
                $set_cover_btn.prop('for',item.id);
                $is_cover.prop('checked',item.is_top);
                //<input type="radio" name="top_img_num" value="0" hidden="hidden" id="img_1">
            }
            /*接收到delItem按钮：删除该缩略图*/
            if(e.target.nodeName=='I'&&$(e.target).hasClass('delItem')){
                var btn = $(e.target),index = btn.data('index');
                CachedFileBox.clearFileBox(index);
                $file_box.html(CachedFileBox.writeHtmlItem()).removeClass('fadeInDown');
                return false;
            }
            /*其他区域：上传*/
            //没有input的不上传
            if(inp.size()==0){return false};
            if(e.target.nodeName=='INPUT'){
                release.uploadFile(id,function(json){
                    $preview.attr('src','.'+json.data);
                    CachedFileBox.attachFileBox(id,json.data,0);
                    $file_box.html(CachedFileBox.writeHtmlItem());
                    //当前label改为该图片对应的radio的id
                    $set_cover_btn.prop('for',id);
                    //将设为封面按钮恢复为未选中
                    $is_cover.prop('checked',false);
                    console.log(id);
                })
            }

        });
        //点选设置封面按钮事件
        $set_cover_btn.on(EVENT_TYPE,function(){
            var id = $(this).attr('for'),
                $for_cover_radio = $('#'+id),
                for_cover_id = $for_cover_radio.parents('li').data('index'),
                item = CachedFileBox.setFileItemIsTop(for_cover_id,(!$is_cover.prop('checked')));
            //设置该id的图片为封面
            $for_cover_radio.prop('checked',item.is_top);
            //勾选已选中
            $is_cover.prop('checked',item.is_top);
        });

        /*缩略图的array*/
        var CachedFileBox = (function(){
            var cache = [];//保留在内存中
            return {
                attachFileBox : function(id,src,is_top){
                    var fsb = this.creatImageItem(id,src,is_top);//新建
                    cache.push(fsb);//更新缓存
                    if(cache.length > 6){
                      cache.pop();
                     }
                    return fsb;
                },
                clearFileBox : function(id){
                   cache.splice(id,1);
                    console.log(cache);
                },
                creatImageItem : function(id,src,is_top){
                    return {id:id,src:src,is_top:is_top};
                },
                writeHtmlItem:function(){
                    var str = '';

                    for(var i=0;i<cache.length;i++){
                        str += '<li data-index="'+i+'"><figure style="background-image:url(.'+cache[i].src+')">';
//                        str += '<input type="file" hidden="hidden" name="'+id+'" class="issue_upload_input" id="'+id+'">';
                        if(cache[i].is_top){
                            str += '<input type="radio" name="top_img_num" value="'+i+'" hidden="hidden" id="'+cache[i].id+'" checked><i>封面</i>';
                        }else{
                            str += '<input type="radio" name="top_img_num" value="'+i+'" hidden="hidden" id="'+cache[i].id+'"><i>封面</i>';
                        }
                        str += '</figure><i class="delItem" data-index="'+i+'"></i></li>';
                    }
                    if(cache.length< 6){
                        str += '<li><figure style="background-image:url({$TMPL}/old/images/add_good.png)" data-index="'+(i+1)+'">';
                        str += '<input type="file" hidden="hidden" name=img_'+(cache.length+1)+' class="issue_upload_input" id="img_'+(cache.length+1)+'">';
                    }
                    return str;
                },
                getFileItem:function(id){
                    return cache[id];
                },
                setFileItemIsTop:function(id,is_top){
                    for(var i=0;i<cache.length;i++){
                        cache[i].is_top = 0;
                    }
                    console.log(cache)
                    cache[id].is_top = is_top;
                    return cache[id];
                }
            };
        })();
    })
</script>
</body>
<html>